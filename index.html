<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3Guysä¸‰è´±å®¢</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h2>3Guysä¸‰è´±å®¢</h2>
    <div>
      <label>äº§å“ç¼–å·ï¼š</label>
      <input type="text" id="productId" readonly>
    </div>
    <div>
      <label>æ‰‹æœºå·ç ï¼š</label>
      <input type="tel" id="phone" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" maxlength="11">
    </div>
    <button onclick="generateCode()">ç”Ÿæˆæ¿€æ´»ç </button>

    <div id="codeResult" style="display: none; margin-top: 20px;">
      <h3>ä½ çš„æ¿€æ´»ç ï¼š<span id="codeText"></span></h3>
    </div>

    <div id="linkBox" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #eee;">
      <!-- <h3>ç›¸å…³é“¾æ¥</h3> -->
      <!-- <p>ğŸ“– ä½¿ç”¨æŒ‡å—ï¼š<a id="guide" target="_blank"></a></p>
      <p>ğŸ“± é£ä¹¦æ–‡æ¡£ï¼š<a id="feishu" target="_blank"></a></p>
      <p>ğŸ”§ å¿«æ·æŒ‡ä»¤ï¼š<a id="shortcut" target="_blank"></a></p> -->
    </div>
  </div>

  <script>
    let productCode = "";

    // 1. è§£æURLä¸­çš„codeå‚æ•°ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
    function getUrlParam(paramName) {
      // è·å–URLä¸­?åçš„å‚æ•°éƒ¨åˆ†
      const searchParams = new URLSearchParams(window.location.search);
      // è¿”å›å‚æ•°å€¼ï¼Œè‹¥æ— åˆ™è¿”å›é»˜è®¤å€¼001
      return searchParams.get(paramName) || "001";
    }

    // 2. é¡µé¢åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨å¡«å……äº§å“ç¼–å·
    window.onload = function() {
      // æå–URLä¸­çš„codeå‚æ•°ï¼ˆæ¯”å¦‚?code=001 â†’ 001ï¼‰
       productCode = getUrlParam("code");
      // å¡«å……åˆ°äº§å“ç¼–å·è¾“å…¥æ¡†
      document.getElementById("productId").value = productCode;
    };

    // åç«¯æ¥å£åœ°å€ï¼ˆå’Œlogin.3guys.com.cnå…±ç”¨åŒä¸€ä¸ªåç«¯ï¼‰
    const API_BASE = "https://3guys.com.cn"; 

    // ç”Ÿæˆæ¿€æ´»ç 
    async function generateCode() {
      const phone = document.getElementById("phone").value.trim();
      if (!/^\d{11}$/.test(phone)) {
        alert("è¯·è¾“å…¥11ä½æœ‰æ•ˆæ‰‹æœºå·ï¼");
        return;
      }

      try {
        const formData = new FormData();
        formData.append("product_id", productCode);
        formData.append("phone", phone);
        
        const res = await fetch(`${API_BASE}/generate_codes`, {
          method: "POST",
          body: formData,
          mode: "cors"
        });
        const data = await res.json();

        if (data.code === 200) {
          // æ˜¾ç¤ºæ¿€æ´»ç 
          document.getElementById("codeText").textContent = data.actcode;
          document.getElementById("codeResult").style.display = "block";
          // è·å–é“¾æ¥ä¿¡æ¯
          getLinks();
        } else {
          alert(data.msg || "æ¿€æ´»ç ç”Ÿæˆå¤±è´¥");
        }
      } catch (e) {
        alert("ç½‘ç»œé”™è¯¯ï¼š" + e.message);
      }
    }

    // è·å–feishu_linkç­‰ä¿¡æ¯
      async function getLinks() {
      // æ¸…ç©ºåŸæœ‰å†…å®¹ï¼ˆé¿å…é‡å¤ç”ŸæˆæŒ‰é’®ï¼‰
      const linkBox = document.getElementById("linkBox");
      linkBox.innerHTML = "";
      linkBox.style.display = "none";

      try {
        // è¯·æ±‚äº§å“é“¾æ¥ä¿¡æ¯
        const res = await fetch(`${API_BASE}/get_product_info?id=${productCode}`);
        const data = await res.json();

        // é€‚é…æ¥å£è¿”å›æ ¼å¼ï¼šstatus=ok ä¸” code=200 ä¸” dataå­˜åœ¨
        if (data.status === "ok" && data.code === 200 && data.data) {
          const linkData = data.data;
          // å®šä¹‰é“¾æ¥é…ç½®ï¼šæŒ‰é’®æ–‡æœ¬ + å¯¹åº”å­—æ®µå
          const linkConfig = [
            { text: "ä½¿ç”¨æŒ‡å—", key: "guide_link" },
            { text: "é£ä¹¦è¡¨æ ¼", key: "feishu_link" },
            { text: "å¿«æ·æŒ‡ä»¤", key: "shortcut_link" }
          ];

          // æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
          const title = document.createElement("h3");
          title.textContent = "ç›¸å…³é“¾æ¥";
          linkBox.appendChild(title);

          // éå†é…ç½®ï¼Œç”Ÿæˆæœ‰æ•ˆæŒ‰é’®
          let hasValidLink = false;
          linkConfig.forEach(item => {
            const linkUrl = linkData[item.key];
            // ä»…å½“é“¾æ¥éç©ºã€é#æ—¶ç”ŸæˆæŒ‰é’®
            if (linkUrl && linkUrl.trim() !== "" && linkUrl !== "#") {
              hasValidLink = true;
              // åˆ›å»ºæŒ‰é’®å…ƒç´ 
              const btn = document.createElement("a");
              btn.className = "link-btn"; // åŠ æ ·å¼ç±»
              btn.textContent = item.text;
              // ç‚¹å‡»äº‹ä»¶ï¼šæ–°çª—å£æ‰“å¼€é“¾æ¥
              btn.onclick = function() {
                window.open(linkUrl, "_blank");
                return false; // é˜»æ­¢aæ ‡ç­¾é»˜è®¤è¡Œä¸ºï¼ˆå¯é€‰ï¼‰
              };
              linkBox.appendChild(btn);
            }
          });

          // æœ‰æœ‰æ•ˆé“¾æ¥æ‰æ˜¾ç¤ºå®¹å™¨
          if (hasValidLink) {
            linkBox.style.display = "block";
          }
        }
      } catch (e) {
        console.error("è·å–é“¾æ¥å¤±è´¥ï¼š", e);
        // å¯é€‰ï¼šæç¤ºç”¨æˆ·
        // alert("è·å–ç›¸å…³é“¾æ¥å¤±è´¥");
      }
    }
  </script>
</body>
</html>